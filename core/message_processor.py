"""
Процессор сообщений - обрабатывает и анализирует сообщения
"""

import asyncio
import logging
from typing import Dict, Any, Optional
from datetime import datetime

class MessageProcessor:
    """Обработчик сообщений для гибридной системы"""
    
    def __init__(self):
        self.логгер = logging.getLogger(__name__)
        
    async def обработать_сообщение(self, сообщение: Dict[str, Any], user_id: int):
        """Обработка входящего сообщения"""
        
        # 1. Анализируем сообщение
        анализ = await self.проанализировать_сообщение(сообщение)
        
        # 2. Проверяем на важность
        важно = await self.проверить_важность(сообщение, анализ)
        
        # 3. Если важно - отправляем админу
        if важно:
            await self.отправить_админу(сообщение, user_id, причина=анализ['причина'])
        
        # 4. Сохраняем для аналитики
        await self.сохранить_для_аналитики(сообщение, анализ)
        
        # 5. Логируем
        self.логгер.info(f"Сообщение обработано: {сообщение.get('message_id')}")
        
        return анализ
    
    async def проанализировать_сообщение(self, сообщение: Dict[str, Any]) -> Dict[str, Any]:
        """Анализ содержания сообщения"""
        текст = сообщение.get('text', '')
        
        анализ = {
            'длина': len(текст),
            'содержит_ссылки': 'http://' in текст or 'https://' in текст,
            'содержит_номера': any(c.isdigit() for c in текст),
            'содержит_ключевые_слова': await self.проверить_ключевые_слова(текст),
            'тональность': await self.определить_тональность(текст),
            'тип_сообщения': self.определить_тип(сообщение)
        }
        
        # Добавляем рекомендации
        анализ['рекомендации'] = await self.сгенерировать_рекомендации(анализ)
        
        return анализ
    
    async def проверить_ключевые_слова(self, текст: str) -> bool:
        """Проверка на ключевые слова"""
        ключевые_слова = ['пароль', 'логин', 'карта', 'паспорт', 'договор', 'срочно']
        текст_нижний = текст.lower()
        return any(слово in текст_нижний for слово in ключевые_слова)
    
    async def определить_тональность(self, текст: str) -> str:
        """Определение тональности сообщения"""
        позитивные = ['спасибо', 'отлично', 'хорошо', 'прекрасно', 'супер']
        негативные = ['проблема', 'ошибка', 'плохо', 'ужасно', 'кошмар']
        
        текст_нижний = текст.lower()
        
        позитив_счет = sum(1 for слово in позитивные if слово in текст_нижний)
        негатив_счет = sum(1 for слово in негативные if слово in текст_нижний)
        
        if позитив_счет > негатив_счет:
            return 'позитивная'
        elif негатив_счет > позитив_счет:
            return 'негативная'
        else:
            return 'нейтральная'
    
    def определить_тип(self, сообщение: Dict[str, Any]) -> str:
        """Определение типа сообщения"""
        if сообщение.get('media_type'):
            return 'медиа'
        elif len(сообщение.get('text', '')) > 100:
            return 'длинное'
        elif len(сообщение.get('text', '')) < 10:
            return 'короткое'
        else:
            return 'текстовое'
    
    async def проверить_важность(self, сообщение: Dict[str, Any], анализ: Dict[str, Any]) -> bool:
        """Проверка, является ли сообщение важным"""
        важно = False
        причины = []
        
        # Критерии важности
        if анализ['содержит_ключевые_слова']:
            важно = True
            причины.append('содержит ключевые слова')
        
        if анализ['тональность'] == 'негативная':
            важно = True
            причины.append('негативная тональность')
        
        if анализ['содержит_ссылки']:
            важно = True
            причины.append('содержит ссылки')
        
        if анализ['содержит_номера'] and анализ['длина'] < 20:
            важно = True
            причины.append('возможно, содержит важные данные')
        
        анализ['важно'] = важно
        анализ['причины_важности'] = причины if важно else []
        
        return важно
    
    async def сгенерировать_рекомендации(self, анализ: Dict[str, Any]) -> list:
        """Генерация рекомендаций на основе анализа"""
        рекомендации = []
        
        if анализ['длина'] > 500:
            рекомендации.append('Сообщение очень длинное, возможно стоит разбить на части')
        
        if анализ['содержит_ссылки']:
            рекомендации.append('Проверьте безопасность ссылок перед переходом')
        
        if анализ['тональность'] == 'негативная':
            рекомендации.append('Рекомендуем сохранять спокойствие в общении')
        
        if not анализ['содержит_ключевые_слова'] and анализ['длина'] < 20:
            рекомендации.append('Сообщение короткое и нейтральное')
        
        return рекомендации
    
    async def отправить_админу(self, сообщение: Dict[str, Any], user_id: int, причина: str = ''):
        """Отправка важного сообщения администратору"""
        # Здесь будет логика отправки через SessionManager
        # Пока просто логируем
        self.логгер.info(f"ВАЖНОЕ СООБЩЕНИЕ от {user_id}: {причина}")
    
    async def сохранить_для_аналитики(self, сообщение: Dict[str, Any], анализ: Dict[str, Any]):
        """Сохранение данных для аналитики"""
        # Сохраняем в структурированном виде
        данные = {
            'timestamp': datetime.now().isoformat(),
            'message_id': сообщение.get('message_id'),
            'analysis': анализ,
            'metadata': {
                'chat_id': сообщение.get('chat_id'),
                'sender_id': сообщение.get('sender_id'),
                'has_media': bool(сообщение.get('media_type'))
            }
        }
        
        # Здесь будет сохранение в БД или файл
        # Пока просто возвращаем данные
        return данные